<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Riwayat Transaksi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap5/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='flatpickr/flatpickr.min.css') }}">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #f8f9fa;
    }

    .navbar-toggler {
      border: none;
    }

    .navbar-toggler:focus {
      box-shadow: none;
    }

    /* Selalu tampilkan toggle (mode mobile) */
    .navbar-toggler {
      display: block !important;
    }

    .navbar-collapse {
      display: none;
    }

    .navbar-collapse.show {
      display: block !important;
    }

    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .form-label {
      font-weight: 500;
    }

    .btn {
      min-width: 120px;
      transition: all 0.3s ease-in-out;
    }

    .btn:hover {
      transform: scale(1.05);
    }

    .table th {
      background-color: #f1f1f1;
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f9f9f9;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: gray;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #splash {
      position: fixed;
      background: white;
      z-index: 9999;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.6s ease;
    }

    #logo {
      max-width: 120px;
      margin-bottom: 12px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid rgba(0, 123, 255, 0.2);
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .pagination-select {
      margin-top: 1rem;
      text-align: center;
    }

    #loading-spinner .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.6);
      z-index: 9998;
    }

    #loading-spinner .spinner-wrapper {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      text-align: center;
    }

    .custom-spinner {
      border: 5px solid #e0e0e0;
      border-top: 5px solid #0d6efd;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 12px;
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0.2;
      font-size: 22px;
      color: #000;
      font-weight: 700;
      z-index: 9999;
      pointer-events: none;
    }

    .watermark img {
      height: 700px;
      max-width: 90vw;
      opacity: 0.5;
    }

    .watermark:hover {
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    @media (max-width: 768px) {
        .watermark img {
            height: 40vh;
        }
    }
  </style>
</head>
<body class="d-flex flex-column">

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='images/logo-ip3.png') }}" alt="Logo PLN" style="height: 40px;">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  </div>

  <div class="collapse navbar-collapse justify-content-center text-center px-3 pb-2" id="mainNavbar">
    <ul class="navbar-nav d-flex flex-column align-items-center w-100">
      <li class="nav-item w-100"><a class="nav-link active" href="/transaksi">TRANSAKSI</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/">ZONA HIJAU</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/merah">ZONA MERAH</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/all">SEMUA ZONA</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/grafik">GRAFIK</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/register">REGISTRASI PERSONAL</a></li>
      <li class="nav-item w-100"><a class="nav-link" href="/register_visitor">REGISTRASI VISITOR</a></li>
    </ul>
  </div>
</nav>

<!-- Splash -->
<div id="splash">
  <img src="{{ url_for('static', filename='images/app.ico') }}" id="logo" alt="Logo">
  <div class="spinner"></div>
  <p class="text-muted mt-3">Memuat halaman...</p>
</div>

<div id="loading-spinner" style="display:none;">
  <div class="overlay"></div>
  <div class="spinner-wrapper">
    <div class="custom-spinner"></div>
    <div class="loading-text">Mengunduh data...</div>
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid flex-fill py-4 fade-in" style="display: none;" id="main-content">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11">
      <div class="card">
        <div class="card-body p-4">
          <h3 class="mb-4 text-center fw-bold">{{ title }}</h3>

          <!-- Filter Form -->
          <form id="filter-form" class="row g-3 align-items-end mb-4">
            <div class="col-md-2">
              <label class="form-label">PIN</label>
              <input type="text" name="id" class="form-control" placeholder="Contoh: 12345678">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nama</label>
              <input type="text" name="nama" class="form-control" placeholder="Contoh: Agus">
            </div>
            <div class="col-md-3">
              <label class="form-label">Departemen</label>
              <input type="text" name="dept" class="form-control" placeholder="Contoh: Maintenance">
            </div>
            <div class="col-md-2">
              <label class="form-label">Dari</label>
              <input type="text" id="dari" name="dari" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">Sampai</label>
              <input type="text" id="ke" name="ke" class="form-control">
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary">üîç Cari</button>
              <a href="#" id="btn-export" class="btn btn-success ms-2">‚¨áÔ∏è Export Excel</a>
            </div>
          </form>

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover" id="result-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nama</th>
                  <th>Departemen</th>
                  <th>PIN</th>
                  <th>First In</th>
                  <th>Last Out</th>
                  <th>Zona Masuk</th>
                  <th>Zona Keluar</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="8" class="loading">Isi form di atas untuk melihat data</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-select">
            <label for="page-select" class="me-2">Halaman:</label>
            <select id="page-select" class="form-select d-inline-block w-auto" onchange="changePage(this.value)">
              <option>1</option>
            </select>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Watermark -->
<div class="watermark">
  <img src="{{ url_for('static', filename='images/SMOOHT.png') }}" alt="OTI">
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='flatpickr/flatpickr.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

<script>
  const pageSelect = document.getElementById('page-select');
  let currentParams = null;

  function formatToSQLDatetime(value) {
    const date = new Date(value);
    const pad = n => n.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:00`;
  }

  document.getElementById('filter-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const form = this;
    const dari = form.querySelector('input[name="dari"]');
    const ke = form.querySelector('input[name="ke"]');

    const formData = new FormData(form);
    formData.set('dari', dari.value ? formatToSQLDatetime(dari.value) : '');
    formData.set('ke', ke.value ? formatToSQLDatetime(ke.value) : '');
    formData.set('page', 1);

    const params = new URLSearchParams(formData);
    currentParams = params;
    loadData(1, params);
  });

  function changePage(page) {
    if (currentParams) {
      currentParams.set('page', page);
      loadData(parseInt(page), currentParams);
    }
  }

  function loadData(page, params) {
    const tableBody = document.querySelector('#result-table tbody');
    tableBody.innerHTML = `<tr><td colspan="8" class="loading">Memuat data...</td></tr>`;

    fetch(`/api/transaksi?${params.toString()}`)
      .then(res => res.json())
      .then(data => {
        if (!data.rows.length) {
          tableBody.innerHTML = `<tr><td colspan="8" class="loading">Data tidak ditemukan</td></tr>`;
          return;
        }

        tableBody.innerHTML = "";
        data.rows.forEach((tx, index) => {
          tableBody.innerHTML += `
            <tr class="fade-in">
              <td>${index + 1 + (data.page - 1) * data.per_page}</td>
              <td>${tx.name}</td>
              <td>${tx.dept_name}</td>
              <td>${tx.pin}</td>
              <td>${tx.first_in_time ?? '-'}</td>
              <td>${tx.last_out_time ?? '-'}</td>
              <td>${tx.reader_name_in ?? '-'}</td>
              <td>${tx.reader_name_out ?? '-'}</td>
            </tr>
          `;
        });

        // Update dropdown pagination
        const totalPages = Math.ceil(data.total / data.per_page);
        pageSelect.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `Halaman ${i}`;
          if (i === data.page) opt.selected = true;
          pageSelect.appendChild(opt);
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
      })
      .catch(err => {
        console.error(err);
        tableBody.innerHTML = `<tr><td colspan="8" class="loading text-danger">Gagal memuat data</td></tr>`;
      });
  }

  const btnExport = document.getElementById('btn-export');
  const spinner = document.getElementById('loading-spinner');

  btnExport.addEventListener('click', function (e) {
    e.preventDefault();
    spinner.style.display = 'block';

    const form = document.getElementById('filter-form');
    const dari = form.querySelector('input[name="dari"]').value;
    const ke = form.querySelector('input[name="ke"]').value;

    const formData = new URLSearchParams();
    if (dari) formData.set('from', formatToSQLDatetime(dari));
    if (ke) formData.set('to', formatToSQLDatetime(ke));

    const id = form.querySelector('input[name="id"]').value;
    const nama = form.querySelector('input[name="nama"]').value;
    const dept = form.querySelector('input[name="dept"]').value;

    if (id) formData.set('id', id);
    if (nama) formData.set('nama', nama);
    if (dept) formData.set('dept', dept);

    const url = `/export?${formData.toString()}`;

    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error("Gagal mengunduh file.");

        const disposition = response.headers.get('Content-Disposition');
        let filename = 'export.xlsx';

        if (disposition && disposition.includes('filename=')) {
          const match = disposition.match(/filename[^;=\n]*=["']?([^"'\n]*)["']?/);
          if (match && match[1]) {
            filename = decodeURIComponent(match[1]);
          }
        }

        return response.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      })
      .catch(err => {
        alert("‚ùå Gagal mengunduh file: " + err.message);
      })
      .finally(() => {
        spinner.style.display = 'none';
      });
  });


  // Navbar auto collapse
  document.querySelectorAll('.navbar-nav .nav-link').forEach(function (el) {
    el.addEventListener('click', function () {
      const navbarCollapse = document.getElementById('mainNavbar');
      const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
      if (bsCollapse) bsCollapse.hide();
    });
  });

  window.addEventListener("DOMContentLoaded", () => {
    flatpickr("#dari", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      time_24hr: true,
      defaultDate: new Date().setHours(0, 0, 0, 0)
    });

    flatpickr("#ke", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      time_24hr: true,
      defaultDate: new Date().setHours(23, 59, 0, 0)
    });

    // Splash screen transition
    setTimeout(() => {
      const splash = document.getElementById("splash");
      splash.style.opacity = 0;
      setTimeout(() => {
        splash.style.display = "none";
        document.getElementById("main-content").style.display = "block";
      }, 600);
    }, 1000);
  });
</script>
</body>
</html>
